<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>2026 è²¡å‹™è³‡ç”¢çµ‚æ¥µå°èˆª - å°ˆæ¥­ç‰ˆ (é‡æ§‹ç‰ˆ)</title>
    <style>
        :root {
            --primary: #2c3e50; --accent: #3498db; --success: #27ae60;
            --warning: #f39c12; --danger: #e74c3c; --bg-light: #f1f5f9;
            --sidebar-bg: #ffffff; --border-color: #e2e8f0; --sidebar-width: 480px;
        }
        body { font-family: "PingFang TC", "Inter", sans-serif; background: var(--bg-light); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #1e293b; }
        .sidebar {
            width: var(--sidebar-width); background: var(--sidebar-bg); border-right: 1px solid var(--border-color);
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
            box-shadow: 4px 0 15px rgba(0,0,0,0.05);
            padding-bottom: 100px; scroll-padding-bottom: 100px;
        }
        h1 { font-size: 1.4rem; margin: 0 0 10px 0; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .section-title {
            font-size: 0.85rem; font-weight: 800; color: #64748b; text-transform: uppercase;
            letter-spacing: 1px; border-bottom: 2px solid var(--accent); padding-bottom: 4px; margin-top: 15px;
        }
        .input-card { background: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label { font-size: 0.75rem; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 4px; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .input-wrapper input {
            width: 100%; padding: 6px 35px 6px 8px; border: 1px solid var(--border-color);
            border-radius: 4px; font-size: 0.85rem; text-align: right; outline: none; transition: border 0.2s;
        }
        .input-wrapper input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(52,152,219,0.1); }
        .input-wrapper .unit { position: absolute; right: 8px; font-size: 0.65rem; color: #94a3b8; font-weight: bold; pointer-events: none; }
        .tooltip-icon { cursor: help; color: #94a3b8; }
        .draggable-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
        .draggable-item {
            background: white; border: 1px solid var(--border-color); border-radius: 6px;
            padding: 8px 12px; display: flex; align-items: center;
            justify-content: space-between; font-size: 0.85rem; transition: background-color 0.2s;
        }
        .draggable-item.dragging { opacity: 0.5; background: #e0f2fe; }
        .drag-handle { cursor: grab; color: #94a3b8; margin-right: 10px; }
        .draggable-item:active .drag-handle { cursor: grabbing; }
        .item-label { display: flex; align-items: center; }
        .main-content { flex: 1; padding: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .table-wrapper {
            background: white; border-radius: 12px; border: 1px solid var(--border-color);
            overflow: auto; flex: 1; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        table { border-collapse: collapse; font-size: 0.75rem; width: 100%; white-space: nowrap; table-layout: fixed; }
        thead th {
            background: #f8fafc; color: #475569; padding: 12px 8px; text-align: right;
            border-bottom: 2px solid var(--border-color); position: sticky; top: 0; z-index: 10;
        }
        tbody td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: right; font-family: 'JetBrains Mono', monospace; }
        .th-toggle { cursor: pointer; user-select: none; }
        .th-toggle:hover { background-color: #f1f5f9; }
        .th-toggle .toggle-icon { font-size: 0.7em; display: inline-block; transition: transform 0.2s; margin-left: 4px; transform: rotate(-90deg); }
        .th-toggle.expanded .toggle-icon { transform: rotate(0deg); }
        .col-hidden { display: none; }
        .group-expanded { background-color: #f8fafc !important; }
        .td-networth { color: #065f46; font-weight: bold; }
        tbody td.td-withdrawing-negative { color: var(--danger); font-weight: 600; }
        tbody td.td-withdrawing-positive { color: #92400e; font-weight: 600; }
        tbody td.td-filling { color: var(--accent); }
        .val-neg { color: var(--danger); font-weight: bold; }
        tbody td.year-col { background: #f8fafc; font-weight: bold; text-align: center; }
        .floating-btn {
            position: fixed; bottom: 30px; left: calc(var(--sidebar-width) - 80px); z-index: 100;
            background: var(--accent); color: white; border: none; height: 52px;
            width: auto; padding: 0 24px; border-radius: 26px; cursor: pointer;
            box-shadow: 0 4px 14px rgba(52, 152, 219, 0.4); display: flex;
            align-items: center; justify-content: center; gap: 10px;
            font-size: 1rem; font-weight: 600; transition: all 0.3s ease;
        }
        .floating-btn:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(52, 152, 219, 0.5); background: #4ea9e0; }
        .floating-btn svg { width: 20px; height: 20px; }
        .explanation-box { margin-top: 15px; border: 1px solid var(--border-color); border-radius: 8px; background: #f8fafc; transition: all 0.3s ease; }
        .explanation-box[open] { background: white; }
        .explanation-box summary { display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; outline: none; font-weight: 600; color: var(--primary); }
        .explanation-box summary::-webkit-details-marker { display: none; }
        .explanation-box .summary-icon { transition: transform 0.3s ease; }
        .explanation-box[open] .summary-icon { transform: rotate(180deg); }
        .explanation-content { padding: 0 15px 15px 15px; font-size: 0.8rem; line-height: 1.6; color: #475569; }
        .explanation-content h4 { font-size: 0.85rem; color: var(--primary); margin-top: 10px; margin-bottom: 8px; border-bottom: 1px solid #e2e8f0; padding-bottom: 4px; }
        .explanation-content ol, .explanation-content ul { padding-left: 20px; margin: 0; }
        .explanation-content li { margin-bottom: 5px; }
    </style>
</head>
<body>

<aside class="sidebar">
    <h1>ğŸ›ï¸ è²¡å‹™è³‡ç”¢å°èˆª</h1>

    <div class="section-title">ğŸ’° è·æ¶¯æ”¶å…¥èˆ‡æ›å·¥</div>
    <div class="input-card">
        <div class="form-grid">
            <div class="form-group"><label for="mSal">å®¶åº­æœˆè–ª</label><div class="input-wrapper"><input type="text" class="comma-num" id="mSal" value="344,000"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="aBon">å¹´åº¦åˆ†ç´…</label><div class="input-wrapper"><input type="text" class="comma-num" id="aBon" value="1,400,000"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="sGr">è–ªè³‡æˆé•·</label><div class="input-wrapper"><input type="number" id="sGr" value="3"><span class="unit">%</span></div></div>
            <div class="form-group"><label for="retA">æ›å·¥å¹´ç´€</label><div class="input-wrapper"><input type="number" id="retA" value="50"><span class="unit">æ­²</span></div></div>
            <div class="form-group"><label for="aRsuGrant">å¹´åº¦RSUæˆäºˆé¡</label><div class="input-wrapper"><input type="text" class="comma-num" id="aRsuGrant" value="1,200,000"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="retIncFactor">æ›å·¥å¾Œæ”¶å…¥æ¯”ä¾‹</label><div class="input-wrapper"><input type="number" id="retIncFactor" value="20"><span class="unit">%</span></div></div>
        </div>
    </div>

    <div class="section-title" style="border-color: var(--success);">ğŸ–ï¸ é€€ä¼‘è¨ˆç•«</div>
    <div class="input-card">
        <div class="form-grid">
            <div class="form-group"><label for="retireAge">é è¨ˆé€€ä¼‘å¹´é½¡</label><div class="input-wrapper"><input type="number" id="retireAge" value="65"><span class="unit">æ­²</span></div></div>
            <!-- â­ HTML ä¿®æ”¹é» -->
            <div class="form-group">
                <label for="retireExpenseFactor">é€€ä¼‘å¾Œç”Ÿæ´»è²»æ¯”ä¾‹</label>
                <div class="input-wrapper">
                    <input type="number" id="retireExpenseFactor" value="70">
                    <span class="unit">%</span>
                </div>
            </div>
        </div>
    </div>

    <div class="section-title">ğŸ’¸ ç”Ÿæ´»æ”¯å‡º (éš¨é€šè†¨)</div>
    <div class="input-card">
        <div class="form-grid">
            <div class="form-group"><label for="mLi">æœˆç”Ÿæ´»è²»</label><div class="input-wrapper"><input type="text" class="comma-num" id="mLi" value="150,000"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="inf">é€šè†¨ç‡</label><div class="input-wrapper"><input type="number" id="inf" value="2"><span class="unit">%</span></div></div>
            <div class="form-group"><label for="aTax">å¹´åº¦ç¶œæ‰€ç¨…</label><div class="input-wrapper"><input type="text" class="comma-num" id="aTax" value="1,200,000"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="aIns">å¹´åº¦ä¿è²»</label><div class="input-wrapper"><input type="text" class="comma-num" id="aIns" value="200,000"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="aTrv">å¹´åº¦æ—…éŠ</label><div class="input-wrapper"><input type="text" class="comma-num" id="aTrv" value="200,000"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="aMisc">å¹´åº¦é›œæ”¯</label><div class="input-wrapper"><input type="text" class="comma-num" id="aMisc" value="100,000"><span class="unit">NTD</span></div></div>
        </div>
    </div>

    <div class="section-title" style="border-color: var(--warning);">ğŸ›¡ï¸ æŠµåˆ©æˆ¿è²¸ç­–ç•¥</div>
    <div class="input-card">
        <div class="form-grid">
            <div class="form-group"><label for="vLo">æˆ¿è²¸é¤˜é¡</label><div class="input-wrapper"><input type="text" class="comma-num" id="vLo" value="32,000,000"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="rLo">æˆ¿è²¸åˆ©ç‡</label><div class="input-wrapper"><input type="number" id="rLo" value="2.18" step="0.01"><span class="unit">%</span></div></div>
            <div class="form-group"><label for="mTerm">æˆ¿è²¸ç¸½æœŸæ•¸</label><div class="input-wrapper"><input type="number" id="mTerm" value="360"><span class="unit">æœˆ</span></div></div>
            <div class="form-group"><label for="tBuf">æŠµåˆ©ç•™å­˜ç›®æ¨™</label><div class="input-wrapper"><input type="text" class="comma-num" id="tBuf" value="5,000,000"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="lGoal">åœæ­¢é‚„æœ¬é–€æª»</label><div class="input-wrapper"><input type="text" class="comma-num" id="lGoal" value="15,000,000"><span class="unit">NTD</span></div></div>
        </div>
    </div>

    <div class="section-title" style="border-color: var(--success);">ğŸ“ˆ æŠ•è³‡é…ç½®</div>
    <div class="input-card">
        <div class="form-grid">
            <div class="form-group"><label for="rTwMkt">å°è‚¡å¹´åŒ–å ±é…¬</label><div class="input-wrapper"><input type="number" id="rTwMkt" value="7"><span class="unit">%</span></div></div>
            <div class="form-group"><label for="rUsMkt">ç¾è‚¡å¹´åŒ–å ±é…¬</label><div class="input-wrapper"><input type="number" id="rUsMkt" value="8"><span class="unit">%</span></div></div>
            <div class="form-group"><label for="rRsu">RSU æˆé•·ç‡</label><div class="input-wrapper"><input type="number" id="rRsu" value="8"><span class="unit">%</span></div></div>
            <div class="form-group"><label for="rPension">å‹é€€æŠ•å ±ç‡</label><div class="input-wrapper"><input type="number" id="rPension" value="6"><span class="unit">%</span></div></div>
            <div class="form-group"><label for="rSavings">å„²è“„éšªæŠ•å ±ç‡</label><div class="input-wrapper"><input type="number" id="rSavings" value="3"><span class="unit">%</span></div></div>
            <div class="form-group"><label for="pensionBase">å‹ä¿æœˆæŠ•ä¿è–ªè³‡</label><div class="input-wrapper"><input type="text" class="comma-num" id="pensionBase" value="45800"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="aPension">å‹é€€è‡ªæå¹´æŠ•é¡</label><div class="input-wrapper"><input type="text" class="comma-num" id="aPension" value="120000"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="pTw">å°è‚¡æŠ•é…æ¯”</label><div class="input-wrapper"><input type="number" id="pTw" value="40"><span class="unit">%</span></div></div>
            <div class="form-group"><label for="pUs">ç¾è‚¡æŠ•é…æ¯”</label><div class="input-wrapper"><input type="number" id="pUs" value="40"><span class="unit">%</span></div></div>
            <div class="form-group"><label for="pCsh">ç¾é‡‘æŠ•é…æ¯”</label><div class="input-wrapper"><input type="number" id="pCsh" value="20"><span class="unit">%</span></div></div>
        </div>
    </div>

    <div class="section-title">ğŸ“Š è³‡ç”¢ç¾å€¼</div>
    <div class="input-card">
        <div class="form-grid">
            <div class="form-group"><label for="vTw">å°è‚¡å¸‚å€¼</label><div class="input-wrapper"><input type="text" class="comma-num" id="vTw" value="11,578,574"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="vUs">ç¾è‚¡å¸‚å€¼</label><div class="input-wrapper"><input type="text" class="comma-num" id="vUs" value="3,875,949"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="vRsu">RSU å¸‚å€¼</label><div class="input-wrapper"><input type="text" class="comma-num" id="vRsu" value="8,251,708"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="vTrust">ä¿¡è¨—å¸‚å€¼</label><div class="input-wrapper"><input type="text" class="comma-num" id="vTrust" value="2,000,000"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="vPension">å‹é€€ç¾å€¼</label><div class="input-wrapper"><input type="text" class="comma-num" id="vPension" value="3,000,000"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="vSavings">å„²è“„éšªç¾å€¼</label><div class="input-wrapper"><input type="text" class="comma-num" id="vSavings" value="1,417,241"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="vCsh">æŠµåˆ©å­˜æ¬¾</label><div class="input-wrapper"><input type="text" class="comma-num" id="vCsh" value="3,244,316"><span class="unit">NTD</span></div></div>
            <div class="form-group"><label for="vInvCsh">æŠ•è³‡ç¾é‡‘</label><div class="input-wrapper"><input type="text" class="comma-num" id="vInvCsh" value="0"><span class="unit">NTD</span></div></div>
        </div>
    </div>

    <div class="section-title" style="border-color: var(--danger);">âš™ï¸ é€²éšç­–ç•¥è¨­å®š</div>
    <div class="input-card">
        <div class="form-grid">
            <div class="form-group"><label for="minBufPct">æŠµåˆ©å­˜æ¬¾æœ€ä½ç·©è¡</label><div class="input-wrapper"><input type="number" id="minBufPct" value="50"><span class="unit">%</span></div></div>
        </div>
        <div style="font-size: 0.75rem; font-weight: 600; color: #475569; margin-top: 10px; margin-bottom: 4px;">è³‡ç”¢æé ˜å„ªå…ˆåº (ç”±ä¸Šè‡³ä¸‹)</div>
        <ul class="draggable-list" id="withdrawal-order-list">
            <li class="draggable-item" draggable="true" data-asset-key="csh"><span class="item-label"><span class="drag-handle">â ¿</span>æŠµåˆ©å­˜æ¬¾</span></li>
            <li class="draggable-item" draggable="true" data-asset-key="invCsh"><span class="item-label"><span class="drag-handle">â ¿</span>æŠ•è³‡ç¾é‡‘</span></li>
            <li class="draggable-item" draggable="true" data-asset-key="us"><span class="item-label"><span class="drag-handle">â ¿</span>ç¾è‚¡</span></li>
            <li class="draggable-item" draggable="true" data-asset-key="rsu"><span class="item-label"><span class="drag-handle">â ¿</span>RSU</span></li>
            <li class="draggable-item" draggable="true" data-asset-key="tw"><span class="item-label"><span class="drag-handle">â ¿</span>å°è‚¡</span></li>
            <li class="draggable-item" draggable="true" data-asset-key="trust"><span class="item-label"><span class="drag-handle">â ¿</span>ä¿¡è¨—</span></li>
            <li class="draggable-item" draggable="true" data-asset-key="pension"><span class="item-label"><span class="drag-handle">â ¿</span>å‹é€€<span class="tooltip-icon" title="å¹´æ»¿ 60 æ­²å¾Œæ‰å¯æé ˜">â”</span></span></li>
            <li class="draggable-item" draggable="true" data-asset-key="savings"><span class="item-label"><span class="drag-handle">â ¿</span>å„²è“„éšª<span class="tooltip-icon" title="2036 å¹´å¾Œæ‰å¯æé ˜">â”</span></span></li>
        </ul>
    </div>

    <details class="explanation-box">
        <summary>
            <span class="summary-title">é‹ç®—é‚è¼¯èªªæ˜</span>
            <span class="summary-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </span>
        </summary>
        <div class="explanation-content">
            <h4>ğŸ“ˆ ç•¶å¹´åº¦ç¾é‡‘æµç‚ºæ­£æ™‚çš„è³‡é‡‘åˆ†é…ï¼š</h4>
            <p>å¹´åº¦çµé¤˜çš„ç¾é‡‘ï¼ˆç¸½æ”¶å…¥ - ç¸½æ”¯å‡ºï¼‰å°‡ä¾ä»¥ä¸‹é †åºåˆ†é…ï¼š</p>
            <ol>
                <li>å„ªå…ˆå¡«è£œã€ŒæŠµåˆ©å­˜æ¬¾ã€è‡³æ‚¨è¨­å®šçš„ã€Œç•™å­˜ç›®æ¨™ã€ã€‚</li>
                <li>å‰©é¤˜çš„è³‡é‡‘å°‡æ ¹æ“šæ‚¨åœ¨ã€ŒæŠ•è³‡é…ç½®ã€ä¸­è¨­å®šçš„ã€Œå°è‚¡/ç¾è‚¡/ç¾é‡‘æŠ•é…æ¯”ã€æŠ•å…¥å°æ‡‰çš„è³‡ç”¢ã€‚</li>
            </ol>
            <h4>ğŸ“‰ ç•¶å¹´åº¦ç¾é‡‘æµç‚ºè² æ™‚çš„è³‡ç”¢æé ˜é †åºï¼š</h4>
            <p>ç³»çµ±å°‡ä¾ç…§æ‚¨åœ¨ã€Œé€²éšç­–ç•¥è¨­å®šã€ä¸­æ‹–æ›³çš„é †åºï¼Œç”±ä¸Šè‡³ä¸‹æé ˜è³‡ç”¢ä»¥è£œè¶³è³‡é‡‘ç¼ºå£ã€‚</p>
            <ol>
                <li><b>æŠµåˆ©å­˜æ¬¾ï¼š</b> æé ˜è‡³ä¸ä½æ–¼æ‚¨è¨­å®šçš„ã€Œæœ€ä½ç·©è¡ã€ç™¾åˆ†æ¯”ã€‚</li>
                <li><b>å…¶ä»–è³‡ç”¢ï¼š</b> ä¾ç…§æ‚¨è¨­å®šçš„é †ä½ä¾åºæé ˜ï¼Œä½†å‹é€€/å„²è“„éšªæœ‰æé ˜æ¢ä»¶é™åˆ¶ã€‚</li>
            </ol>
            <h4>âš™ï¸ å…¶ä»–é‡è¦é‹ç®—å‡è¨­ï¼š</h4>
            <ul>
                <li><b>é€šè†¨å½±éŸ¿ï¼š</b>æ‰€æœ‰ã€Œç”Ÿæ´»æ”¯å‡ºã€ç›¸é—œçš„å¹´åº¦è²»ç”¨çš†æœƒä¾æ“šæ‚¨è¨­å®šçš„é€šè†¨ç‡é€å¹´æˆé•·ã€‚</li>
                <li><b>è·æ¶¯éšæ®µè®ŠåŒ–ï¼š</b>
                    <ul>
                        <li><b>æ›å·¥éšæ®µï¼š</b>åˆ°é”ã€Œæ›å·¥å¹´ç´€ã€å¾Œï¼Œæ‚¨çš„ã€Œå®¶åº­ç¸½æ”¶å…¥ã€èˆ‡ã€Œå¹´åº¦ç¶œæ‰€ç¨…ã€å°‡ä¾æ‚¨è¨­å®šçš„ã€Œæ›å·¥å¾Œæ”¶å…¥æ¯”ä¾‹ã€èª¿æ•´ã€‚</li>
                        <li><b>é€€ä¼‘éšæ®µï¼š</b>åˆ°é”ã€Œé€€ä¼‘å¹´é½¡ã€å¾Œï¼Œæ‰€æœ‰ä¸»å‹•æ”¶å…¥ï¼ˆè–ªè³‡ã€åˆ†ç´…ã€RSUæˆäºˆã€å‹é€€ææ’¥ï¼‰èˆ‡ç¶œæ‰€ç¨…çš†æ­¸é›¶ã€‚ç”Ÿæ´»é–‹éŠ·æ”¹æ¡ã€Œé€€ä¼‘å‰ç¸½ç”Ÿæ´»é–‹éŠ·ã€ä¹˜ä»¥æ‚¨è¨­å®šçš„ã€Œé€€ä¼‘å¾Œç”Ÿæ´»è²»æ¯”ä¾‹ã€ä¾†è¨ˆç®—ã€‚</li>
                    </ul>
                </li>
                <li><b>è³‡ç”¢å¢å€¼ï¼š</b>å„é …è³‡ç”¢æ–¼æ¯å¹´å¹´åº•çµç®—ä¸€æ¬¡å¹´åº¦æˆé•·ã€‚</li>
                <li><b>æŠµåˆ©æˆ¿è²¸ï¼š</b>æˆ¿è²¸åˆ©æ¯æ˜¯æ ¹æ“šã€Œæˆ¿è²¸é¤˜é¡ã€æ¸›å»ã€ŒæŠµåˆ©å­˜æ¬¾ã€å¾Œçš„æ·¨é¡ä¾†è¨ˆç®—ã€‚ç•¶æˆ¿è²¸é¤˜é¡ä½æ–¼ã€Œåœæ­¢é‚„æœ¬é–€æª»ã€æ™‚ï¼Œç³»çµ±å°‡åªç¹³åˆ©æ¯ï¼Œä¸å†å„Ÿé‚„æœ¬é‡‘ã€‚</li>
                <li><b>å‹é€€ææ’¥ï¼š</b>å‹é€€å¸³æˆ¶çš„å¹´åº¦æŠ•å…¥åŒ…å«ã€Œå€‹äººè‡ªæã€èˆ‡ã€Œé›‡ä¸»ææ’¥ã€å…©éƒ¨åˆ†ã€‚é›‡ä¸»ææ’¥é‡‘é¡æ˜¯æ ¹æ“šæ‚¨å¡«å¯«çš„ã€Œå‹ä¿æœˆæŠ•ä¿è–ªè³‡ã€ä»¥ 6% è¨ˆç®—ã€‚</li>
            </ul>
        </div>
    </details>
</aside>

<button class="floating-btn">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><line x1="12" y1="10" x2="12" y2="18"></line><line x1="8" y1="10" x2="8" y2="18"></line><line x1="8" y1="14" x2="12" y2="14"></line>
    </svg>
    <span>é‡æ–°è¨ˆç®—</span>
</button>

<main class="main-content">
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width: 40px;">å¹´ç´€</th>
                    <th style="width: 50px;">å¹´åº¦</th>
                    <th>ç¸½æ”¶å…¥</th>
                    <th class="th-toggle" id="th-toggle-expense">ç¸½æ”¯å‡º<span class="toggle-icon">â–¼</span></th>
                    <th class="col-hidden" data-group="expense">ç”Ÿæ´»æ”¯å‡º</th>
                    <th class="col-hidden" data-group="expense">æˆ¿è²¸æ”¯å‡º</th>
                    <th>ç¾é‡‘æµ</th>
                    <th class="th-toggle" id="th-toggle-investment">æ–°å¢æŠ•è³‡<span class="toggle-icon">â–¼</span></th>
                    <th class="col-hidden" data-group="investment">æŠ•å…¥å°è‚¡</th>
                    <th class="col-hidden" data-group="investment">æŠ•å…¥ç¾è‚¡</th>
                    <th class="col-hidden" data-group="investment">æŠ•å…¥æŠ•è³‡ç¾é‡‘</th>
                    <th>æŠ•è³‡ç¾é‡‘</th>
                    <th>æŠµåˆ©å­˜æ¬¾</th>
                    <th>æˆ¿è²¸é¤˜é¡</th>
                    <th>å°è‚¡</th>
                    <th>ç¾è‚¡</th>
                    <th>RSU</th>
                    <th class="th-toggle" id="th-toggle-other-assets">å…¶ä»–è³‡ç”¢<span class="toggle-icon">â–¼</span></th>
                    <th class="col-hidden" data-group="other-assets">ä¿¡è¨—</th>
                    <th class="col-hidden" data-group="other-assets">å‹é€€</th>
                    <th class="col-hidden" data-group="other-assets">å„²è“„éšª</th>
                    <th class="th-toggle" id="th-toggle-networth" style="width: 120px;">ç¸½æ·¨è³‡ç”¢<span class="toggle-icon">â–¼</span></th>
                    <th class="col-hidden" data-group="networth">ç¸½è³‡ç”¢</th>
                    <th class="col-hidden" data-group="networth">ç¸½è² å‚µ</th>
                </tr>
            </thead>
            <tbody id="resB"></tbody>
        </table>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- GLOBAL CONFIGURATION ---
    const CONFIG = {
        SIMULATION_YEARS: 40, START_AGE: 40, START_YEAR: 2026,
        SAFE_ASSET_RETURN_RATE: 1.04,
        PENSION_WITHDRAW_AGE: 60, SAVINGS_WITHDRAW_YEAR: 2036,
        LOCAL_STORAGE_KEY: 'financialNavigatorSettings', 
        // â­ JS ä¿®æ”¹é» 1
        INPUT_IDS_TO_SAVE: [
            'mSal', 'aBon', 'sGr', 'retA', 'aRsuGrant', 'retIncFactor', 
            'retireAge', 'retireExpenseFactor', 'mLi', 'inf', 'aTax', 
            'aIns', 'aTrv', 'aMisc', 'vLo', 'rLo', 'mTerm', 'tBuf', 'lGoal', 
            'rTwMkt', 'rUsMkt', 'rRsu', 'rPension', 'rSavings', 'pensionBase', 'aPension', 
            'pTw', 'pUs', 'pCsh', 'vTw', 'vUs', 'vRsu', 'vTrust', 'vPension', 
            'vSavings', 'vCsh', 'vInvCsh', 'minBufPct'
        ]
    };

    class UIController {
        constructor() {
            this.resultBody = document.getElementById('resB');
            this.runButton = document.querySelector('.floating-btn');
            this.commaInputs = document.querySelectorAll('.comma-num');
            this.toggleHeaders = document.querySelectorAll('.th-toggle');
            this.withdrawalOrderList = document.getElementById('withdrawal-order-list');
        }

        _parseNum(id, isRate = false) {
            const el = document.getElementById(id);
            if (!el) return 0;
            const val = parseFloat(el.value.replace(/,/g, '')) || 0;
            return isRate ? 1 + val / 100 : val;
        }

        _formatNum(num) {
            return Math.round(num).toLocaleString('en-US');
        }

        getParams() {
            // â­ JS ä¿®æ”¹é» 2
            return {
                mSal: this._parseNum('mSal'), aBon: this._parseNum('aBon'), sGr: this._parseNum('sGr', true), retA: this._parseNum('retA'),
                mLi: this._parseNum('mLi'), inf: this._parseNum('inf', true), aTax: this._parseNum('aTax'),
                aIns: this._parseNum('aIns'), aTrv: this._parseNum('aTrv'), aMisc: this._parseNum('aMisc'), aPension: this._parseNum('aPension'),
                vLo: this._parseNum('vLo'), rLoMon: (this._parseNum('rLo') / 100) / 12, tBuf: this._parseNum('tBuf'), lGoal: this._parseNum('lGoal'),
                mTerm: this._parseNum('mTerm'), aRsuGrant: this._parseNum('aRsuGrant'),
                retIncFactor: this._parseNum('retIncFactor') / 100,
                retireAge: this._parseNum('retireAge'),
                retireExpenseFactor: this._parseNum('retireExpenseFactor') / 100,
                pensionBase: this._parseNum('pensionBase'),
                rTwMkt: this._parseNum('rTwMkt', true), rUsMkt: this._parseNum('rUsMkt', true), rRsu: this._parseNum('rRsu', true),
                rPension: this._parseNum('rPension', true), rSavings: this._parseNum('rSavings', true),
                pTw: this._parseNum('pTw') / 100, pUs: this._parseNum('pUs') / 100, pCsh: this._parseNum('pCsh') / 100,
                minBufPct: this._parseNum('minBufPct') / 100,
                withdrawalOrder: [...this.withdrawalOrderList.querySelectorAll('.draggable-item')].map(item => item.dataset.assetKey),
            };
        }

        getInitialAssets() {
            return {
                tw: this._parseNum('vTw'), us: this._parseNum('vUs'), rsu: this._parseNum('vRsu'),
                trust: this._parseNum('vTrust'), pension: this._parseNum('vPension'), savings: this._parseNum('vSavings'),
                csh: this._parseNum('vCsh'), invCsh: this._parseNum('vInvCsh'),
            };
        }

        renderTable(rowsHtml) {
            this.resultBody.innerHTML = rowsHtml;
        }

        generateRowHtml(data) {
            const { cAge, cYear, annInc, annOut, livingExpenses, mortgageExpenses, netCash, assets, prevAssets, curLo, totalNW, totalAssets, totalLiabilities, otherAssetsTotal, drawTriggers, params, totalInvestment, investedTw, investedUs, investedCash } = data;
            
            const getWithdrawalClass = (key) => {
                if (drawTriggers[key] > 0) {
                    return assets[key] < prevAssets[key] ? 'td-withdrawing-negative' : 'td-withdrawing-positive';
                }
                return '';
            };

            return `
                <tr>
                    <td class="year-col">${cAge}</td>
                    <td class="year-col">${cYear}</td>
                    <td>${this._formatNum(annInc)}</td>
                    <td data-group-master="expense">${this._formatNum(annOut)}</td>
                    <td class="col-hidden" data-group="expense">${this._formatNum(livingExpenses)}</td>
                    <td class="col-hidden" data-group="expense">${this._formatNum(mortgageExpenses)}</td>
                    <td class="${netCash < 0 ? 'val-neg' : ''}">${this._formatNum(netCash)}</td>
                    <td data-group-master="investment" class="td-filling">${this._formatNum(totalInvestment)}</td>
                    <td class="col-hidden td-filling" data-group="investment">${this._formatNum(investedTw)}</td>
                    <td class="col-hidden td-filling" data-group="investment">${this._formatNum(investedUs)}</td>
                    <td class="col-hidden td-filling" data-group="investment">${this._formatNum(investedCash)}</td>
                    <td class="${getWithdrawalClass('invCsh')}">${this._formatNum(assets.invCsh)}</td>
                    <td class="${assets.csh < params.tBuf ? 'td-filling' : ''} ${getWithdrawalClass('csh')}">${this._formatNum(assets.csh)}</td>
                    <td style="color:#64748b">${this._formatNum(curLo)}</td>
                    <td class="${getWithdrawalClass('tw')}">${this._formatNum(assets.tw)}</td>
                    <td class="${getWithdrawalClass('us')}">${this._formatNum(assets.us)}</td>
                    <td class="${getWithdrawalClass('rsu')}">${this._formatNum(assets.rsu)}</td>
                    <td data-group-master="other-assets">${this._formatNum(otherAssetsTotal)}</td>
                    <td class="col-hidden ${getWithdrawalClass('trust')}" data-group="other-assets">${this._formatNum(assets.trust)}</td>
                    <td class="col-hidden ${getWithdrawalClass('pension')}" data-group="other-assets">${this._formatNum(assets.pension)}</td>
                    <td class="col-hidden ${getWithdrawalClass('savings')}" data-group="other-assets">${this._formatNum(assets.savings)}</td>
                    <td class="td-networth" data-group-master="networth">${this._formatNum(totalNW)}</td>
                    <td class="col-hidden" data-group="networth">${this._formatNum(totalAssets)}</td>
                    <td class="col-hidden" data-group="networth">${this._formatNum(totalLiabilities)}</td>
                </tr>`;
        }

        _getColumnExpansionStates() {
            const states = {};
            this.toggleHeaders.forEach(header => {
                const groupName = header.id.replace('th-toggle-', '');
                states[groupName] = header.classList.contains('expanded');
            });
            return states;
        }

        _applyColumnExpansionStates(states) {
            for (const groupName in states) {
                this._setColumnGroupVisibility(groupName, states[groupName]);
            }
        }

        _setColumnGroupVisibility(groupName, isVisible) {
            const header = document.getElementById(`th-toggle-${groupName}`);
            if (!header) return;
            const cells = document.querySelectorAll(`[data-group="${groupName}"], [data-group-master="${groupName}"]`);
            header.classList.toggle('expanded', isVisible);
            cells.forEach(cell => {
                if (!cell.hasAttribute('data-group-master')) {
                    cell.classList.toggle('col-hidden', !isVisible);
                }
                cell.classList.toggle('group-expanded', isVisible);
            });
        }

        saveInputsToLocalStorage() {
            const settingsToSave = {};
            
            const inputValues = {};
            CONFIG.INPUT_IDS_TO_SAVE.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    inputValues[id] = element.value;
                }
            });
            settingsToSave.inputValues = inputValues;

            const withdrawalOrder = [...this.withdrawalOrderList.querySelectorAll('.draggable-item')]
                .map(item => item.dataset.assetKey);
            settingsToSave.withdrawalOrder = withdrawalOrder;

            localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY, JSON.stringify(settingsToSave));
            console.log('Settings saved to localStorage.');
        }

        loadInputsFromLocalStorage() {
            const savedSettings = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY);
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);

                if (settings.inputValues) {
                    CONFIG.INPUT_IDS_TO_SAVE.forEach(id => {
                        const element = document.getElementById(id);
                        if (element && settings.inputValues[id] !== undefined) {
                            element.value = settings.inputValues[id];
                        }
                    });
                }

                if (settings.withdrawalOrder) {
                    const savedOrder = settings.withdrawalOrder;
                    const currentItems = {};
                    this.withdrawalOrderList.querySelectorAll('.draggable-item').forEach(item => {
                        currentItems[item.dataset.assetKey] = item;
                    });

                    this.withdrawalOrderList.innerHTML = '';

                    savedOrder.forEach(key => {
                        if (currentItems[key]) {
                            this.withdrawalOrderList.appendChild(currentItems[key]);
                        }
                    });
                }
                console.log('Settings loaded from localStorage.');
            }
        }

        bindEvents(runSimCallback) {
            this.runButton.addEventListener('click', () => {
                this.saveInputsToLocalStorage();
                runSimCallback();
            });

            this.commaInputs.forEach(input => {
                input.addEventListener('input', function() {
                    let val = this.value.replace(/,/g, '');
                    if (!isNaN(val) && val !== '') this.value = Number(val).toLocaleString('en-US');
                });
            });

            this.toggleHeaders.forEach(header => {
                const groupName = header.id.replace('th-toggle-', '');
                header.addEventListener('click', () => {
                    const isCurrentlyExpanded = header.classList.contains('expanded');
                    this._setColumnGroupVisibility(groupName, !isCurrentlyExpanded);
                });
                this._setColumnGroupVisibility(groupName, false);
            });

            this.withdrawalOrderList.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = this._getDragAfterElement(this.withdrawalOrderList, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (dragging) {
                    if (afterElement == null) {
                        this.withdrawalOrderList.appendChild(dragging);
                    } else {
                        this.withdrawalOrderList.insertBefore(dragging, afterElement);
                    }
                }
            });

            this.withdrawalOrderList.querySelectorAll('.draggable-item').forEach(draggable => {
                draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
                draggable.addEventListener('dragend', () => draggable.classList.remove('dragging'));
            });
        }

        _getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
    }

    class SimulationState {
        constructor(params, initialAssets) {
            this.params = params;
            this.assets = { ...initialAssets };
            this.loanBalance = params.vLo;
            this.monthlySalary = params.mSal;
            this.annualBonus = params.aBon;
            this.drawTriggers = {};
        }

        _calculateMortgage() {
            if (this.loanBalance <= 0) return { yearlyInterest: 0, yearlyPrincipalRepay: 0 };
            let yearlyInterest = 0, yearlyPrincipalRepay = 0;
            const monthlyPayment = this.params.vLo * (this.params.rLoMon * Math.pow(1 + this.params.rLoMon, this.params.mTerm)) / (Math.pow(1 + this.params.rLoMon, this.params.mTerm) - 1);
            
            for (let m = 0; m < 12; m++) {
                const interestBasis = Math.max(0, this.loanBalance - this.assets.csh);
                const monthInterest = interestBasis * this.params.rLoMon;
                yearlyInterest += monthInterest;
                if (this.loanBalance > this.params.lGoal) {
                    let monthPrincipal = Math.max(0, monthlyPayment - monthInterest);
                    monthPrincipal = Math.min(this.loanBalance, monthPrincipal);
                    this.loanBalance -= monthPrincipal;
                    yearlyPrincipalRepay += monthPrincipal;
                }
            }
            this.loanBalance = Math.max(0, this.loanBalance);
            return { yearlyInterest, yearlyPrincipalRepay };
        }

        _handleCashflowDistribution(netCash, context) {
            this.drawTriggers = Object.keys(this.assets).reduce((acc, key) => ({ ...acc, [key]: 0 }), {});
            let investedTw = 0, investedUs = 0, investedCash = 0;
            
            if (netCash > 0) {
                let investableCash = netCash;
                const fillAmount = Math.min(investableCash, this.params.tBuf - this.assets.csh);
                if (fillAmount > 0) { 
                    this.assets.csh += fillAmount; 
                    investableCash -= fillAmount; 
                }
                
                investedTw = investableCash * this.params.pTw;
                investedUs = investableCash * this.params.pUs;
                investedCash = investableCash * this.params.pCsh;

                this.assets.tw += investedTw;
                this.assets.us += investedUs;
                this.assets.invCsh += investedCash;

            } else {
                let gap = -netCash;
                for (const assetKey of this.params.withdrawalOrder) {
                    if (gap <= 0) break;
                    if (assetKey === 'pension' && context.age < CONFIG.PENSION_WITHDRAW_AGE) continue;
                    if (assetKey === 'savings' && context.year < CONFIG.SAVINGS_WITHDRAW_YEAR) continue;

                    let available = this.assets[assetKey] || 0;
                    if (available <= 0) continue;

                    if (assetKey === 'csh') {
                        available = Math.max(0, this.assets.csh - (this.params.tBuf * this.params.minBufPct));
                    }

                    const amountToWithdraw = Math.min(available, gap);
                    this.assets[assetKey] -= amountToWithdraw;
                    gap -= amountToWithdraw;
                    this.drawTriggers[assetKey] = amountToWithdraw;
                }
            }
            return { investedTw, investedUs, investedCash };
        }

        _growAssets(isFullyRetired) {
            this.assets.tw *= this.params.rTwMkt;
            this.assets.us *= this.params.rUsMkt;
            this.assets.rsu = (this.assets.rsu * this.params.rRsu) + (isFullyRetired ? 0 : this.params.aRsuGrant);
            this.assets.trust *= CONFIG.SAFE_ASSET_RETURN_RATE;
            
            const employerPension = isFullyRetired ? 0 : this.params.pensionBase * 0.06 * 12;
            const employeePension = isFullyRetired ? 0 : this.params.aPension;
            const totalPensionContribution = employerPension + employeePension;
            
            this.assets.pension = (this.assets.pension + totalPensionContribution) * this.params.rPension;
            this.assets.savings *= this.params.rSavings;
        }

        _growIncome() {
            this.monthlySalary *= this.params.sGr;
            this.annualBonus *= this.params.sGr;
        }

        runYear(i) {
            const prevAssets = { ...this.assets };
            const cAge = CONFIG.START_AGE + i;
            const cYear = CONFIG.START_YEAR + i;

            const isJobChanged = cAge >= this.params.retA && cAge < this.params.retireAge;
            const isFullyRetired = cAge >= this.params.retireAge;

            let annInc = 0;
            let currentTax = 0;
            let currentLivingExpenses = 0;
            let currentPensionContribution = 0;

            // â­ JS ä¿®æ”¹é» 3: çµ±ä¸€è¨ˆç®—é‚è¼¯
            const preRetirementBaseExpenses = this.params.mLi * 12 + this.params.aIns + this.params.aTrv + this.params.aMisc;

            if (isFullyRetired) {
                // é€€ä¼‘éšæ®µ
                annInc = 0;
                currentTax = 0;
                currentLivingExpenses = preRetirementBaseExpenses * this.params.retireExpenseFactor;
                currentPensionContribution = 0;
            } else if (isJobChanged) {
                // æ›å·¥éšæ®µ
                annInc = (this.monthlySalary * 12 + this.annualBonus) * this.params.retIncFactor;
                currentTax = this.params.aTax * this.params.retIncFactor;
                currentLivingExpenses = preRetirementBaseExpenses;
                currentPensionContribution = this.params.aPension;
            } else {
                // å·¥ä½œéšæ®µ
                annInc = this.monthlySalary * 12 + this.annualBonus;
                currentTax = this.params.aTax;
                currentLivingExpenses = preRetirementBaseExpenses;
                currentPensionContribution = this.params.aPension;
            }

            const { yearlyInterest, yearlyPrincipalRepay } = this._calculateMortgage();
            
            const inflationFactor = Math.pow(this.params.inf, i);
            const livingExpenses = currentLivingExpenses * inflationFactor + currentTax;
            const mortgageExpenses = yearlyPrincipalRepay + yearlyInterest;
            const annOut = livingExpenses + mortgageExpenses + currentPensionContribution;
            const netCash = annInc - annOut;

            const { investedTw, investedUs, investedCash } = this._handleCashflowDistribution(netCash, { age: cAge, year: cYear });
            const totalInvestment = investedTw + investedUs + investedCash;

            this._growAssets(isFullyRetired);
            
            if (!isFullyRetired) {
                this._growIncome();
            }

            const otherAssetsTotal = this.assets.trust + this.assets.pension + this.assets.savings;
            const totalAssets = this.assets.tw + this.assets.us + this.assets.rsu + this.assets.invCsh + this.assets.csh + otherAssetsTotal;
            const totalLiabilities = this.loanBalance;
            const totalNW = totalAssets - totalLiabilities;

            return {
                cAge, cYear, annInc, annOut, livingExpenses, mortgageExpenses, netCash,
                assets: { ...this.assets }, prevAssets, curLo: this.loanBalance,
                totalNW, totalAssets, totalLiabilities, otherAssetsTotal,
                drawTriggers: { ...this.drawTriggers }, params: this.params,
                totalInvestment, investedTw, investedUs, investedCash,
            };
        }
    }

    function main() {
        const ui = new UIController();

        function runSimulation() {
            const expansionStates = ui._getColumnExpansionStates();

            ui.commaInputs.forEach(input => {
                const event = new Event('input');
                input.dispatchEvent(event);
            });

            const params = ui.getParams();
            const initialAssets = ui.getInitialAssets();
            const simState = new SimulationState(params, initialAssets);
            
            let allRowsHtml = '';
            for (let i = 0; i <= CONFIG.SIMULATION_YEARS; i++) {
                const yearData = simState.runYear(i);
                allRowsHtml += ui.generateRowHtml(yearData);
            }
            ui.renderTable(allRowsHtml);
            ui._applyColumnExpansionStates(expansionStates);
        }

        ui.loadInputsFromLocalStorage();
        ui.bindEvents(runSimulation);
        runSimulation();
    }

    main();
});
</script>
</body>
</html>
